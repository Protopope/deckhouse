{{- $ciliumVersion := "1.14.5" }}
---
artifact: {{ $.ModuleName }}/{{ $.ImageName }}-builder-artifact
git:
  - add: /{{ $.ModulePath }}modules/021-{{ $.ModuleName }}/images/{{ $.ImageName }}/patches
    to: /patches
    stageDependencies:
      install:
        - '**/*'
fromImage: {{ $.ModuleName }}/builder-artifact
mount:
  - fromPath: ~/go-pkg-cache
    to: /go/pkg
shell:
  beforeInstall:
    - mkdir /tmp/cilium-repo
    - curl -sSL https://github.com/cilium/cilium/archive/refs/tags/v{{ $ciliumVersion }}.tar.gz | tar xvz -C /tmp/cilium-repo
  install:
    - export PATH=$PATH:/usr/local/go/bin
    - cd /tmp/cilium-repo/cilium-{{ $ciliumVersion }}
    - find /patches -name '*.patch' -exec git apply {} \;
    - make PKG_BUILD=1 SKIP_DOCS=true DESTDIR=/tmp/install build-container install-container-binary
    - make PKG_BUILD=1 SKIP_DOCS=true DESTDIR=/tmp/install install-bash-completion licenses-all
    - mv LICENSE.all /tmp/install/LICENSE.all
    - cp -t /tmp/install images/cilium/init-container.sh plugins/cilium-cni/install-plugin.sh plugins/cilium-cni/cni-uninstall.sh
---
image: {{ .ModuleName }}/{{ .ImageName }}
fromImage: common/shell-operator
import:
  - artifact: {{ $.ModuleName }}/{{ $.ImageName }}-builder-artifact
    add: /tmp/install
    to: /
    before: install
git:
  - add: /{{ $.ModulePath }}modules/021-{{ $.ModuleName }}/images/{{ $.ImageName }}/hooks
    to: /hooks
    stageDependencies:
      install:
        - '**/*'
