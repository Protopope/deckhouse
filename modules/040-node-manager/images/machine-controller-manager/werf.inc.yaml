image: {{ .ModuleName }}/{{ .ImageName }}
fromImage: common/distroless
docker:
  ENV:
    WORKDIR: /
    ENTRYPOINT: "/machine-controller-manager"
import:
- artifact: {{ .ModuleName }}/{{ .ImageName }}/build
  add: /src/bin/machine-controller-manager
  to: /machine-controller-manager
  before: setup
---
artifact: {{ .ModuleName }}/{{ .ImageName }}/build
from: {{ .Images.BASE_GOLANG_ALPINE }}
fromCacheVersion: "20210607"
mount:
- fromPath: ~/go-pkg-cache
  to: /go/pkg
shell:
  install:
  - apk add mercurial make bash git
  setup:
  - mkdir /src && cd /src
  - git clone --depth 1 --branch v0.36.0-flant.13 {{ env "SOURCE_REPO" | default "https://github.com" }}/deckhouse/mcm.git .
  - make build-local
  - chown 64535:64535 bin/machine-controller-manager
  - chmod 0700 bin/machine-controller-manager
